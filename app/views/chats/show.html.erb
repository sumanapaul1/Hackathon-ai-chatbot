<div class="chat-container">
  <div class="chat-header">
    Apartment Assistant
  </div>
  <div class="chat-body" id="chat-body">
    <% @chat.messages.each do |message| %>
      <%= render partial: "chats/message", locals: { message: message } %>
    <% end %>
  </div>
  <div class="chat-footer">
      <%= render partial: "chats/form", locals: { chat: @chat } %>
  </div>
</div>
<script>
  $(document).ready(function() {
      debugger;
      const chatBody = $('#chat-body');
      const messageInput = $('#message-input');
      const sendButton = $('#send-button');

      function scrollToBottom() {
      chatBody.scrollTop(chatBody[0].scrollHeight);
      }
      scrollToBottom();

      function sendMessage() {
      const content = messageInput.val().trim();
      if (!content) return;

      chatBody.append(`
        <div class="message user">${content}</div>
      `);
      scrollToBottom();
      messageInput.val('');

      chatBody.append('<div class="typing-indicator" id="typing">Assistant is typing...</div>');
      scrollToBottom();

      $.ajax({
        url:$('#chat_form').attr('action'),
        method: 'POST',
        data:{ submission: { input: content } }, 
        headers: {
        'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        success: function(response) {
        $('#typing').remove();
        console.log(response.messages)
        let html = ''
        response.messages.forEach(msg => {
            if(msg.role === 'bot') {
            html = `<div class="message bot"><div class="bot-avatar">AI</div><div>${msg.content.replace(/\n/g, '<br>')}</div></div>`
            }
            chatBody.append(html);
        });
        scrollToBottom();
        },
        error: function() {
          $('#typing').remove();
          chatBody.append('<div class="message bot"><div class="bot-avatar">AI</div><div>Sorry, something went wrong. Try again!</div></div>');
          scrollToBottom();
        }
      });
      }
      sendButton.click(sendMessage);
      messageInput.keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        sendMessage();
      }
      });
  });
</script>
 